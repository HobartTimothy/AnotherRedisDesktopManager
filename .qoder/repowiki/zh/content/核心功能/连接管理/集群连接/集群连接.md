# 集群连接

<cite>
**本文档引用的文件**   
- [redisClient.js](file://src/redisClient.js)
- [storage.js](file://src/storage.js)
- [Connections.vue](file://src/components/Connections.vue)
- [README.md](file://README.md)
- [addon.js](file://src/addon.js)
</cite>

## 目录
1. [引言](#引言)
2. [集群连接初始化机制](#集群连接初始化机制)
3. [连接选项封装](#连接选项封装)
4. [集群连接界面设计](#集群连接界面设计)
5. [连接配置持久化](#连接配置持久化)
6. [内网集群连接方案](#内网集群连接方案)
7. [集群环境下的连接管理](#集群环境下的连接管理)
8. [集群连接示例](#集群连接示例)
9. [结论](#结论)

## 引言
Another Redis Desktop Manager (ARDM) 是一款功能强大的 Redis 桌面管理工具，支持多种 Redis 部署模式，包括单机、哨兵和集群模式。本文档将深入解析 ARDM 对 Redis 集群模式的支持机制，重点阐述 `redisClient.js` 中 `createConnection` 方法如何根据 `config.cluster` 标志位初始化 `Redis.Cluster` 实例，以及 `getClusterOptions` 函数对连接选项的封装过程。同时，本文将探讨 `Connections.vue` 组件中集群连接界面的设计，`storage.js` 如何序列化和持久化集群连接配置，并结合 `README.md` 中的 Docker/LAN/AWS 内网集群连接方案，提供通过 SSH 跳板机连接内网集群的实际操作指南。

## 集群连接初始化机制
ARDM 通过 `redisClient.js` 文件中的 `createConnection` 方法来初始化不同模式的 Redis 连接。该方法根据传入的 `config` 对象中的 `cluster` 标志位来决定创建何种类型的客户端实例。

当 `config.cluster` 为 `true` 时，系统会进入集群模式分支。此时，方法会调用 `getClusterOptions` 函数来生成集群专用的配置选项，并使用 `ioredis` 库的 `Redis.Cluster` 构造函数创建集群客户端。此过程确保了连接能够正确地与 Redis 集群进行交互，利用集群的分片和高可用特性。

**Section sources**
- [redisClient.js](file://src/redisClient.js#L51-L87)

## 连接选项封装
`getClusterOptions` 函数负责封装集群连接所需的所有选项。该函数接收两个参数：`redisOptions`（基础 Redis 连接选项）和 `natMap`（网络地址映射）。

函数返回一个包含以下关键配置的对象：
- **connectionName**: 从 `redisOptions` 中继承的连接名称。
- **enableReadyCheck**: 设置为 `false`，禁用就绪检查。
- **slotsRefreshTimeout**: 设置为 30000 毫秒（30 秒），定义了刷新集群槽位映射的超时时间。
- **redisOptions**: 包含基础连接参数的对象。
- **natMap**: 一个映射对象，用于处理网络地址转换（NAT），将集群内部的 IP 地址映射到外部可访问的地址。

`natMap` 的使用对于连接位于内网或通过 SSH 隧道访问的集群至关重要，它允许客户端正确地与集群中的各个节点通信。

**Section sources**
- [redisClient.js](file://src/redisClient.js#L242-L249)

## 集群连接界面设计
`Connections.vue` 组件负责管理所有连接的列表和用户界面。该组件提供了一个直观的界面，允许用户创建、编辑和管理连接，包括集群连接。

在连接配置对话框中，用户可以通过勾选“集群模式”选项来启用集群连接。组件通过 `v-model` 绑定 `connection.cluster` 属性，当用户启用该选项时，`config.cluster` 标志位将被设置为 `true`，从而在连接时触发集群模式的初始化流程。

**Section sources**
- [Connections.vue](file://src/components/Connections.vue#L1-L326)

## 连接配置持久化
`storage.js` 文件负责管理所有连接配置的持久化。它使用浏览器的 `localStorage` 来存储和检索连接信息。

当用户创建或编辑一个连接时，`storage.js` 会调用 `addConnection` 或 `editConnectionByKey` 方法，将连接配置（包括 `cluster` 标志位和 `natMap` 等高级配置）序列化为 JSON 字符串并保存到 `localStorage` 中。这确保了用户的连接配置在应用重启后依然存在，实现了连接信息的安全存储与快速加载。

**Section sources**
- [storage.js](file://src/storage.js#L1-L329)

## 内网集群连接方案
对于部署在 Docker、局域网（LAN）或 AWS 内网等私有网络中的 Redis 集群，ARDM 提供了通过 SSH 跳板机进行连接的解决方案。

根据 `README.md` 中的指南，用户需要：
1.  首先通过 SSH 连接到跳板机。
2.  在 ARDM 中，不勾选“集群模式”，连接到跳板机上可访问的 Redis 节点（通常是集群中的一个节点）。
3.  打开命令行控制台，执行 `CLUSTER NODES` 命令。
4.  从命令返回的结果中，选择任意一个节点的内部 IP 地址和端口。
5.  在连接配置中，将 Redis 主机设置为该内部 IP 地址，并勾选“集群模式”和“SSH 隧道”选项。

此流程利用 SSH 隧道将本地端口转发到内网的 Redis 节点，再通过 `CLUSTER NODES` 命令获取完整的集群拓扑，从而实现对内网集群的全面访问。

**Section sources**
- [README.md](file://README.md#L310-L317)

## 集群环境下的连接管理
在集群环境下，ARDM 实现了复杂的连接管理逻辑。当通过 SSH 连接到集群时，`createSSHConnection` 方法会：
1.  首先创建一个到 SSH 跳板机的连接。
2.  使用该连接执行 `CLUSTER NODES` 命令，获取集群中所有主节点的地址信息。
3.  为每个集群节点创建独立的 SSH 隧道。
4.  使用 `initNatMap` 函数生成 `natMap`，将集群内部地址映射到本地 SSH 隧道的端口。
5.  最后，使用包含 `natMap` 的配置创建最终的 `Redis.Cluster` 客户端。

这种机制确保了客户端能够通过单一的 SSH 跳板机，与分布在内网各处的多个 Redis 节点进行通信，实现了无缝的集群管理体验。

**Section sources**
- [redisClient.js](file://src/redisClient.js#L90-L147)

## 集群连接示例
通过命令行启动 ARDM 并直接连接到集群的示例如下：
```bash
# Linux
./Another Redis Desktop Manager.AppImage --host 127.0.0.1 --port 6379 --cluster

# Windows
"D:\path\to\Another Redis Desktop Manager.exe" --host 127.0.0.1 --port 6379 --cluster

# macOS
open /Applications/Another\ Redis\ Desktop\ Manager.app --args --host 127.0.0.1 --port 6379 --cluster
```
此命令会创建一个名为 `tmp_connection` 的临时集群连接。`--cluster` 参数会设置 `config.cluster` 为 `true`，触发集群模式的初始化。

**Section sources**
- [addon.js](file://src/addon.js#L67-L69)
- [README.md](file://README.md#L251-L253)

## 结论
Another Redis Desktop Manager 通过精心设计的代码架构，实现了对 Redis 集群模式的全面支持。其核心在于 `redisClient.js` 中基于 `config.cluster` 标志位的条件分支，以及 `getClusterOptions` 函数对 `slotsRefreshTimeout` 和 `natMap` 等高级选项的封装。结合 `Connections.vue` 的用户界面和 `storage.js` 的持久化机制，ARDM 为用户提供了一个强大且易用的工具，无论是连接本地集群还是通过 SSH 访问内网集群，都能提供流畅的管理体验。